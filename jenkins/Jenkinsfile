pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'pipeline-batch-clima'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        
        // ========================================
        // CI - CONTINUOUS INTEGRATION
        // ========================================
        
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Baixando cÃ³digo do repositÃ³rio...'
                checkout scm
            }
        }
        
        stage('Setup Python') {
            steps {
                echo 'ğŸ Instalando Python e pip...'
                sh '''
                    # Instala Python e pip se nÃ£o existir
                    which python3 || (apt-get update && apt-get install -y python3 python3-pip python3-venv)
                    which pip3 || apt-get install -y python3-pip
                    
                    python3 --version
                    pip3 --version || python3 -m pip --version
                '''
            }
        }
        
        stage('Lint') {
            steps {
                echo 'ğŸ” Verificando sintaxe do cÃ³digo...'
                sh '''
                    echo "=== Verificando arquivos Python ==="
                    
                    python3 -m py_compile src/ingestion/engine.py && echo "âœ“ src/ingestion/engine.py"
                    python3 -m py_compile src/ingestion/pipelines/clima.py && echo "âœ“ src/ingestion/pipelines/clima.py"
                    python3 -m py_compile src/ingestion/pipelines/solos.py && echo "âœ“ src/ingestion/pipelines/solos.py"
                    python3 -m py_compile src/ingestion/pipelines/agricultura.py && echo "âœ“ src/ingestion/pipelines/agricultura.py"
                    
                    python3 -m py_compile src/validation/engine.py && echo "âœ“ src/validation/engine.py"
                    python3 -m py_compile src/validation/pipelines/clima.py && echo "âœ“ src/validation/pipelines/clima.py"
                    python3 -m py_compile src/validation/pipelines/solos.py && echo "âœ“ src/validation/pipelines/solos.py"
                    python3 -m py_compile src/validation/pipelines/agricultura.py && echo "âœ“ src/validation/pipelines/agricultura.py"
                    
                    echo ""
                    echo "âœ… Lint OK - Todos os arquivos vÃ¡lidos!"
                '''
            }
        }
        
        stage('Tests') {
            steps {
                echo 'ğŸ§ª Rodando testes unitÃ¡rios...'
                sh '''
                    echo "=== Instalando dependÃªncias ==="
                    python3 -m pip install --quiet --break-system-packages pytest pandas pyarrow boto3 google-auth google-api-python-client python-dotenv apache-airflow
                    
                    echo ""
                    echo "=== Rodando testes ==="
                    export PYTHONPATH="${WORKSPACE}"
                    
                    python3 -m pytest tests/ -v --tb=short --junitxml=test-results.xml
                    
                    echo ""
                    echo "âœ… Testes concluÃ­dos!"
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'test-results.xml'
                }
            }
        }
        
        // ========================================
        // CD - CONTINUOUS DEPLOYMENT
        // ========================================
        
        stage('Build Docker') {
            when {
                branch 'main'
            }
            steps {
                echo 'ğŸ³ Construindo imagem Docker...'
                sh '''
                    cd docker
                    docker build -t pipeline-clima-airflow:latest -f Dockerfile ..
                    echo "âœ… Imagem construÃ­da!"
                '''
            }
        }
        
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'ğŸš€ Fazendo deploy no Airflow...'
                sh '''
                    cd docker
                    docker-compose down --remove-orphans || true
                    docker-compose up -d --build
                    echo "âœ… Deploy concluÃ­do!"
                '''
            }
        }
        
        stage('Health Check') {
            when {
                branch 'main'
            }
            steps {
                echo 'â¤ï¸ Verificando saÃºde do Airflow...'
                sh '''
                    echo "Aguardando Airflow iniciar..."
                    sleep 30
                    
                    for i in 1 2 3 4 5; do
                        if curl -s http://localhost:8080/health 2>/dev/null | grep -q "healthy"; then
                            echo "âœ… Airflow estÃ¡ saudÃ¡vel!"
                            exit 0
                        fi
                        echo "Tentativa $i/5 - Aguardando..."
                        sleep 10
                    done
                    
                    echo "âš ï¸ Timeout, mas deploy foi feito"
                '''
            }
        }
    }
    
    post {
        success {
            echo '''
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘         âœ… PIPELINE SUCESSO!              â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
            emailext(
                subject: "âœ… Sucesso no Pipeline: ${env.PROJECT_NAME} #${env.BUILD_NUMBER}",
                body: """O pipeline rodou com sucesso!
                Veja os detalhes em: ${env.BUILD_URL}console""",
                from: "luisfelipetoledo.profissional@gmail.com",
                to: "luisfelipetoledo.profissional@gmail.com"
            )
        }
        failure {
            echo '''
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘         âŒ PIPELINE FALHOU!               â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
            emailext(
                subject: "âŒ Falha no Pipeline: ${env.PROJECT_NAME} #${env.BUILD_NUMBER}",
                body: """O pipeline falhou!
                Verifique os logs em: ${env.BUILD_URL}console""",
                from: "luisfelipetoledo.profissional@gmail.com",
                to: "luisfelipetoledo.profissional@gmail.com"
            )
        }
        always {
            cleanWs()
        }
    }

}
