pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'pipeline-batch-clima'
        AIRFLOW_IMAGE = 'pipeline-clima-airflow'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        
        // ========================================
        // CI - CONTINUOUS INTEGRATION
        // ========================================
        
        stage('Checkout') {
            steps {
                echo '๐ฅ Baixando cรณdigo do repositรณrio...'
                checkout scm
            }
        }
        
        stage('Lint') {
            steps {
                echo '๐ Verificando sintaxe do cรณdigo...'
                sh '''
                    # Roda verificaรงรฃo de sintaxe dentro de um container Python
                    docker run --rm \
                        -v "${WORKSPACE}:/app" \
                        -w /app \
                        python:3.10-slim \
                        bash -c "
                            echo '=== Verificando arquivos Python ==='
                            
                            python -m py_compile src/ingestion/engine.py && echo 'โ src/ingestion/engine.py'
                            python -m py_compile src/ingestion/pipelines/clima.py && echo 'โ src/ingestion/pipelines/clima.py'
                            python -m py_compile src/ingestion/pipelines/solos.py && echo 'โ src/ingestion/pipelines/solos.py'
                            python -m py_compile src/ingestion/pipelines/agricultura.py && echo 'โ src/ingestion/pipelines/agricultura.py'
                            
                            python -m py_compile src/validation/engine.py && echo 'โ src/validation/engine.py'
                            python -m py_compile src/validation/pipelines/clima.py && echo 'โ src/validation/pipelines/clima.py'
                            python -m py_compile src/validation/pipelines/solos.py && echo 'โ src/validation/pipelines/solos.py'
                            python -m py_compile src/validation/pipelines/agricultura.py && echo 'โ src/validation/pipelines/agricultura.py'
                            
                            echo ''
                            echo 'โ Lint OK - Todos os arquivos vรกlidos!'
                        "
                '''
            }
        }
        
        stage('Tests') {
            steps {
                echo '๐งช Rodando testes unitรกrios...'
                sh '''
                    chmod +x jenkins/scripts/run_tests.sh
                    ./jenkins/scripts/run_tests.sh
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'test-results.xml'
                }
            }
        }
        
        // ========================================
        // CD - CONTINUOUS DEPLOYMENT
        // ========================================
        
        stage('Build Docker') {
            when {
                branch 'main'
            }
            steps {
                echo '๐ณ Construindo imagem Docker...'
                sh '''
                    chmod +x jenkins/scripts/build_docker.sh
                    ./jenkins/scripts/build_docker.sh
                '''
            }
        }
        
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo '๐ Fazendo deploy no Airflow...'
                sh '''
                    chmod +x jenkins/scripts/deploy.sh
                    ./jenkins/scripts/deploy.sh
                '''
            }
        }
        
        stage('Health Check') {
            when {
                branch 'main'
            }
            steps {
                echo 'โค๏ธ Verificando saรบde do Airflow...'
                sh '''
                    echo "Aguardando Airflow iniciar..."
                    sleep 30
                    
                    # Tenta verificar saรบde
                    for i in 1 2 3 4 5; do
                        if curl -s http://localhost:8080/health 2>/dev/null | grep -q "healthy"; then
                            echo "โ Airflow estรก saudรกvel!"
                            exit 0
                        fi
                        echo "Tentativa $i/5 - Aguardando..."
                        sleep 10
                    done
                    
                    echo "โ๏ธ Airflow nรฃo respondeu, mas deploy foi feito"
                '''
            }
        }
    }
    
    post {
        success {
            echo '''
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         โ PIPELINE SUCESSO!              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  โข Cรณdigo validado                        โ
โ  โข Testes passaram                        โ
โ  โข Deploy realizado                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            '''
        }
        failure {
            echo '''
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         โ PIPELINE FALHOU!               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  Verifique os logs acima para detalhes    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            '''
        }
        always {
            cleanWs()
        }
    }
}
